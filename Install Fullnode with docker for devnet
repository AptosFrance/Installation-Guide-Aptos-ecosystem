Guide d'installation d'un fullnode en docker pour le devnet
Comprend l'update du fullnode à chaque mise à jour du Devnet
Par Kbconsulting45

Pour éviter les problèmes, tout d'abord ouvrir tous les ports necessaires via la commande ufw :

ufw enable
ufw allow 22
ufw allow 6180
ufw allow 6181
ufw allow 6182
ufw allow 9101
ufw allow 8080

Now, declare variables:
echo "export WORKSPACE=devnet" >> $HOME/.bash_profile

echo "export PUBLIC_IP=$(curl -s ifconfig.me)" >> $HOME/.bash_profile

source $HOME/.bash_profile


Update Packages
sudo apt update && sudo apt upgrade -y

Dependencies Install
sudo apt-get install jq unzip -y

Docker Install :
sudo apt-get install ca-certificates curl gnupg lsb-release -y

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io -y






Docker Compose Install
mkdir -p ~/.docker/cli-plugins/

curl -SL https://github.com/docker/compose/releases/download/v2.2.3/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose

chmod +x ~/.docker/cli-plugins/docker-compose

sudo chown $USER /var/run/docker.sock

Download Aptos CLI
wget -qO aptos-cli.zip https://github.com/aptos-labs/aptos-core/releases/download/aptos-cli-v0.1.1/aptos-cli-0.1.1-Ubuntu-x86_64.zip

unzip -o aptos-cli.zip -d /usr/local/bin

chmod +x /usr/local/bin/aptos

rm aptos-cli.zip


Create a directory for your local public FullNode, and cd into it
mkdir /root/devnet
cd /root/devnet

Download the following YAML configuration files:
wget https://raw.githubusercontent.com/aptos-labs/aptos-core/main/docker/compose/public_full_node/docker-compose.yaml
wget https://raw.githubusercontent.com/aptos-labs/aptos-core/main/docker/compose/public_full_node/public_full_node.yaml








Now you have to edit the two config files as shown below:
First the docker-compose.yaml :
# This compose file defines a Public Fullnode docker compose wrapper around aptos-node.
#
# In order to use, place a copy of the proper genesis.blob and waypoint.txt in this directory.
#
# Developer testnet genesis blob and waypoint can be found at:
# `curl https://devnet.aptoslabs.com/waypoint.txt --output waypoint.txt`
# `curl https://devnet.aptoslabs.com/genesis.blob --output genesis.blob`
#
# Note this compose comes with a pre-configured node.config for fullnodes, see
# public_full_node.yaml. The config is pretty well documented and aligns with instructions herein.
# It is intended for use with testnet but can be easily modified for other systems.
#
# To start the docker compose:
# `docker-compose -f docker-compose.yaml up -d`
#
# Additional information:
# * If you use this compose for different Aptos Networks, you will need remove the db volume first.
# * Aptos's testnet produces approximately 3 GB worth of chain data per day, so be patient while
# starting for the first time. As a sanity check, enter the container and check the increasing size
# of the db:
#   * `docker exec -it $CONTAINER_ID /bin/bash`
#   * `du -csm /opt/aptos/data``
#
# Monitoring:
# If you want to install the monitoring components for your fullnode
# you can symlink the ../monitoring folder into this directory.
# Note that you will need to rename the monitoring docker-compose.yaml file to avoid duplication.
# e.g. rename it to docker-compose.mon.yaml and run:
# `docker-compose -f docker-compose.yaml -f docker-compose.mon.yaml up -d`
# Dashboard can be accessed locally by loading localhost:3000 on your browser
version: "3.8"
services:
  fullnode:
    image: aptoslab/validator:devnet
    volumes:
      - type: volume
        source: db
        target: /opt/aptos/data
      - type: bind
        source: ./genesis.blob
        target: /opt/aptos/etc/genesis.blob
        read_only: true
      - type: bind
        source: ./public_full_node.yaml
        target: /opt/aptos/etc/node.yaml
        read_only: true
      - type: bind
        source: ./waypoint.txt
        target: /opt/aptos/etc/waypoint.txt
        read_only: true
    command: ["/opt/aptos/bin/aptos-node", "-f", "/opt/aptos/etc/node.yaml"]
    ports:
      - "8080:8080"
      - "9101:9101"
      - "6180:6180"
volumes:
  db:

Second edit the public-fullnode.yaml
base:
    # This is the location Aptos will store its database. It is backed by a dedicated docker volume
    # for persistence.
    data_dir: "/opt/aptos/data"
    role: "full_node"
    waypoint:
        # This is a checkpoint into the blockchain for added security.
        from_file: "/opt/aptos/etc/waypoint.txt"

state_sync:
  state_sync_driver:
    enable_state_sync_v2: true

execution:
    # Path to a genesis transaction. Note, this must be paired with a waypoint. If you update your
    # waypoint without a corresponding genesis, the file location should be an empty path.
    genesis_file_location: "/opt/aptos/etc/genesis.blob"

full_node_networks:
    - network_id: "public"
      discovery_method: "onchain"
      # The network must have a listen address to specify protocols. This runs it locally to
      # prevent remote, incoming connections.
      listen_address: "/ip4/0.0.0.0/tcp/6180"
      # Define the upstream peers to connect to
      seeds:
        {}

api:
    # This specifies your REST API endpoint. Intentionally on public so that Docker can export it.
    address: 0.0.0.0:8080


The Aptos devnet publishes the genesis.blob and waypoint.txt files. Download them:
wget https://devnet.aptolabs.com/genesis.blob
wget https://devnet.aptoslabs.com/waypoint.txt

Start Docker Compose by running the command:
docker compose up -d




Part 04: Update your fullnode at each new devnet release

Every week a new release of the devnet is making available by Aptos Team. So that you have to update your fullnode.
To do it here’s what to do:

Shutdown your FullNode
docker compose stop

Now you have to clean your fullnode docker :
docker compose down

First list your docker images and keep the id:
docker images -a
Now delete the images :
docker image rm yourimageid -f

Now do the same thing with the docker db volume:
List the docker db volume and keep the id:
docker volume ls

And now delete it:
docker volume rm volumeid -f

Now your docker is clean

Delete the “old “ genesis.blob and the waypoint.txt:
cd /root/aptos-fullnode
rm genesis.blob
rm waypoint.txt




Download the latest Docker images with: 
docker pull docker.io/aptoslabs/validator:devnet

Now download the new genesis.blob and waytpoint.txt :
wget https://devnet.aptoslabs.com/genesis.blob
wget https://devnet.aptoslabs.com/waypoint.txt

Now you just have to start your fullnode:
docker compose up -d

You did it Congrat

Now you can verify that your fullnode is operational:
Go to https://aptos-node.info and type your public address
Rq: if you don’t know about your public address, here’s the command:
wget -qO- icanhazip.com
If you have questions or something went wrong come on Aptos France TG : @kbconsulting45
